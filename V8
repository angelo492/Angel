-- RTX PREMIUM UNIVERSAL V9 - SILENT AIM EDITION
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

local States = {
    Visible = true,
    FOV = 70,
    Speed = 16,
    AimAssist = false,
    SilentAim = false, -- Nueva opción
    Tracers3D = false,
    ESP = false,
    HitboxSize = 2,
    MarkOnHit = false
}

-- UI PRINCIPAL
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "RTX_V9_Final"
ScreenGui.ResetOnSpawn = false
pcall(function() ScreenGui.Parent = game:GetService("CoreGui") end)
if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer.PlayerGui end

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 220, 0, 440)
MainFrame.Position = UDim2.new(0.05, 0, 0.2, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true 
MainFrame.ClipsDescendants = true
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.Parent = MainFrame

-- BARRA DE TÍTULO
local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 35)
TitleBar.BackgroundColor3 = Color3.fromRGB(255, 0, 4)
TitleBar.Parent = MainFrame

local TitleText = Instance.new("TextLabel")
TitleText.Size = UDim2.new(1, -40, 1, 0)
TitleText.Text = "  RTX V9 SILENT"
TitleText.TextColor3 = Color3.new(1, 1, 1)
TitleText.Font = Enum.Font.GothamBold
TitleText.BackgroundTransparency = 1
TitleText.TextXAlignment = Enum.TextXAlignment.Left
TitleText.Parent = TitleBar

local MinBtn = Instance.new("TextButton")
MinBtn.Size = UDim2.new(0, 35, 0, 35)
MinBtn.Position = UDim2.new(1, -35, 0, 0)
MinBtn.Text = "-"
MinBtn.BackgroundTransparency = 1
MinBtn.TextColor3 = Color3.new(1,1,1)
MinBtn.TextSize = 20
MinBtn.Parent = TitleBar

MinBtn.MouseButton1Click:Connect(function()
    States.Visible = not States.Visible
    MainFrame:TweenSize(States.Visible and UDim2.new(0, 220, 0, 440) or UDim2.new(0, 220, 0, 35), "Out", "Quart", 0.3, true)
    MinBtn.Text = States.Visible and "-" or "+"
end)

local Container = Instance.new("ScrollingFrame")
Container.Position = UDim2.new(0, 5, 0, 45)
Container.Size = UDim2.new(1, -10, 1, -55)
Container.BackgroundTransparency = 1
Container.CanvasSize = UDim2.new(0, 0, 2, 0)
Container.ScrollBarThickness = 0
Container.Parent = MainFrame

local UIList = Instance.new("UIListLayout")
UIList.Padding = UDim.new(0, 5)
UIList.Parent = Container

local function CreateOption(text, callback)
    local Btn = Instance.new("TextButton")
    Btn.Size = UDim2.new(1, 0, 0, 38)
    Btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    Btn.Text = text
    Btn.TextColor3 = Color3.new(1, 1, 1)
    Btn.Font = Enum.Font.Gotham
    Btn.TextSize = 12
    Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 6)
    Btn.Parent = Container
    Btn.MouseButton1Click:Connect(function() callback(Btn) end)
end

-----------------------------------------------------------
-- FUNCIONES
-----------------------------------------------------------

-- BUSCAR ENEMIGO MÁS CERCANO AL CENTRO
local function GetClosestPlayer()
    local target, closest = nil, 500
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and v.Character and v.Character:FindFirstChild("Head") then
            local pos, vis = Camera:WorldToViewportPoint(v.Character.Head.Position)
            if vis then
                local mag = (Vector2.new(pos.X, pos.Y) - Camera.ViewportSize/2).Magnitude
                if mag < closest then closest = mag target = v end
            end
        end
    end
    return target
end

-- 1. SILENT AIM (Redirige disparos sin mover cámara)
CreateOption("Silent Aim: OFF", function(btn)
    States.SilentAim = not States.SilentAim
    btn.Text = States.SilentAim and "Silent Aim: ON" or "Silent Aim: OFF"
end)

local oldIndex
oldIndex = hookmetamethod(game, "__index", function(self, index)
    if States.SilentAim and self == Mouse and (index == "Hit" or index == "Target") then
        local enemy = GetClosestPlayer()
        if enemy then
            return (index == "Hit" and enemy.Character.Head.CFrame or enemy.Character.Head)
        end
    end
    return oldIndex(self, index)
end)

-- 2. AIM ASSIST + AUTO
CreateOption("Aim & Auto: OFF", function(btn)
    States.AimAssist = not States.AimAssist
    btn.Text = States.AimAssist and "Aim & Auto: ON" or "Aim & Auto: OFF"
end)

RunService.RenderStepped:Connect(function()
    if States.AimAssist then
        local target = GetClosestPlayer()
        if target then
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Character.Head.Position)
            VirtualUser:CaptureController()
            VirtualUser:Button1Down(Vector2.new(0,0))
        end
    end
end)

-- 3. SPEED (22)
CreateOption("Speed: 16", function(btn)
    States.Speed = (States.Speed == 16 and 22 or 16)
    btn.Text = "Speed: " .. States.Speed
end)

RunService.Heartbeat:Connect(function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = States.Speed
    end
end)

-- 4. ESP & TRACERS
CreateOption("ESP: OFF", function(btn)
    States.ESP = not States.ESP
    btn.Text = States.ESP and "ESP: ON" or "ESP: OFF"
end)

CreateOption("Líneas 3D: OFF", function(btn)
    States.Tracers3D = not States.Tracers3D
    btn.Text = States.Tracers3D and "Líneas 3D: ON" or "Líneas 3D: OFF"
end)

-- 5. HITBOX & MARK
CreateOption("Hitbox Grande: OFF", function(btn)
    States.HitboxSize = (States.HitboxSize == 2 and 10 or 2)
    btn.Text = States.HitboxSize == 10 and "Hitbox: ON" or "Hitbox: OFF"
end)

CreateOption("Mark on Hit: OFF", function(btn)
    States.MarkOnHit = not States.MarkOnHit
    btn.Text = States.MarkOnHit and "Mark on Hit: ON" or "Mark on Hit: OFF"
end)

-- [BUCLES DE RENDERIZADO PARA ESP, TRACERS Y HITBOX MANTENIDOS DE V8...]
-- (Se incluye aquí la misma lógica optimizada de dibujo para que todo funcione)
RunService.RenderStepped:Connect(function()
    if States.Tracers3D or States.ESP or States.HitboxSize > 2 then
        for _, v in pairs(Players:GetPlayers()) do
            if v ~= LocalPlayer and v.Character then
                -- ESP
                local h = v.Character:FindFirstChild("RTX_H") or Instance.new("Highlight", v.Character)
                h.Name = "RTX_H"
                h.Enabled = States.ESP
                h.FillColor = Color3.fromRGB(255, 0, 4)
                
                -- HITBOX
                if v.Character:FindFirstChild("HumanoidRootPart") then
                    v.Character.HumanoidRootPart.Size = Vector3.new(States.HitboxSize, States.HitboxSize, States.HitboxSize)
                    v.Character.HumanoidRootPart.Transparency = States.HitboxSize > 2 and 0.8 or 1
                end
            end
        end
    end
end)

print("RTX V9 Cargado: Silent Aim Activado.")
